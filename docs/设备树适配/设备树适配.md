# 设备树适配

## extlinux启动引导配置


```shell

default rockchip-kernel-4.4
menu title Kdev U-Boot menu
prompt 1
timeout 90

label rockchip-kernel-4.4
	kernel /extlinux/Image
	fdt /extlinux/toybrick.dtb
	append  earlycon=uart8250,mmio32,0xff1a0000 initrd=/initramfs-toybrick-2.0.img root=PARTUUID=614e0000-0000-4b53-8000-1d28000054a9 rw rootwait rootfstype=ext4

label rockchip-kernel-6.6
	kernel /extlinux/Image-6.6
	fdt /extlinux/rk3399pro-toybrick-prod.dtb
	append  earlycon=uart8250,mmio32,0xff1a0000 console=ttyS2,1500000 rw rootwait rootfstype=ext4 initrd=/initrd.img-4.4.194 level=10 log_level=10 root=PARTUUID=614e0000-0000-4b53-8000-1d28000054a9


```

---

## emmc

### 硬件电路

### dts设备树

```shell
sdhci: sdhci@fe330000 {
		compatible = "rockchip,rk3399-sdhci-5.1", "arasan,sdhci-5.1";
		reg = <0x0 0xfe330000 0x0 0x10000>;
		interrupts = <GIC_SPI 11 IRQ_TYPE_LEVEL_HIGH 0>;
		arasan,soc-ctl-syscon = <&grf>;
		assigned-clocks = <&cru SCLK_EMMC>;
		assigned-clock-rates = <200000000>;
		clocks = <&cru SCLK_EMMC>, <&cru ACLK_EMMC>;
		clock-names = "clk_xin", "clk_ahb";
		clock-output-names = "emmc_cardclock";
		#clock-cells = <0>;
		phys = <&emmc_phy>;
		phy-names = "phy_arasan";
		power-domains = <&power RK3399_PD_EMMC>;
		status = "disabled";
	};
```

### 内核驱动

```shell
# rg rockchip,rk3399-sdhci-5.1

drivers/mmc/host/sdhci-of-arasan.c
1475:		.compatible = "rockchip,rk3399-sdhci-5.1",
1927:	if (of_device_is_compatible(np, "rockchip,rk3399-sdhci-5.1"))
```

因此需要打开 CONFIG_MMC_SDHCI_OF_ARASAN 配置，否则emmc无法识别

```shell
# grep sdhci-of-arasan drivers/mmc/host/Makefile
obj-$(CONFIG_MMC_SDHCI_OF_ARASAN)	+= sdhci-of-arasan.o
```

---

## ethernet

### dts设备树

```shell
&gmac {
	phy-supply = <&vcc_phy>;
	phy-mode = "rgmii";
	clock_in_out = "input";
	snps,reset-gpio = <&gpio3 RK_PC0 GPIO_ACTIVE_LOW>;
	snps,reset-active-low;
	snps,reset-delays-us = <0 10000 50000>;
	assigned-clocks = <&cru SCLK_RMII_SRC>;
	assigned-clock-parents = <&clkin_gmac>;
	pinctrl-names = "default";
	pinctrl-0 = <&rgmii_pins>;
	tx_delay = <0x28>;
	rx_delay = <0x20>;
	status = "okay";
};
```

### 内核驱动

```shell
# rg "rockchip,rk3399-gmac"

drivers/net/ethernet/stmicro/stmmac/dwmac-rk.c
2109:	{ .compatible = "rockchip,rk3399-gmac", .data = &rk3399_ops },
```

```shell
# grep -i dwmac-rk drivers/net/ethernet/stmicro/stmmac/Makefile 
obj-$(CONFIG_DWMAC_ROCKCHIP)	+= dwmac-rk.o
# 
# grep -i CONFIG_DWMAC_ROCKCHIP .config
CONFIG_DWMAC_ROCKCHIP=y
# 
```

必须配置 CONFIG_DWMAC_ROCKCHIP 否则缺失驱动


---

## led

### 硬件电路

### dts设备树

```shell
	leds: gpio-leds {
		compatible = "gpio-leds";
		pinctrl-names = "default";
		pinctrl-0 =<&leds_gpio>;

		led@1 {
			gpios = <&gpio2 RK_PA5 GPIO_ACTIVE_HIGH>;
			label = "system_work_led1"; // Blue LED
			retain-state-suspended;
		};

		led@2 {
			gpios = <&gpio2 RK_PA4 GPIO_ACTIVE_HIGH>;
			label = "system_work_led2"; // Red LED
			retain-state-suspended;
		};

		led@3 {
			gpios = <&gpio2 RK_PA3 GPIO_ACTIVE_HIGH>;
			label = "system_work_led3"; // Green LED
			retain-state-suspended;
		};
	};
```

### 内核驱动

---

## usb配置

### 硬件电路

RK3399包含以下USB控制器：

1. USB 3.0 (USB3.0 Type-C/xHCI)：1个USB3.0 Dual-Role控制器（支持OTG）
2. USB 2.0 EHCI/OHCI：2个USB2.0主机控制器
3. USB PHY：包括Type-C PHY和USB2 PHY

```shell
USB 控制器层级
├── Bus 06: OHCI 控制器 (12M)        ← USB 1.1
├── Bus 05: EHCI 控制器 (480M)       ← USB 2.0 高速
│   └── RTL8723DU 无线网卡+蓝牙
├── Bus 04: xHCI 控制器 (5000M)      ← USB 3.0
│   └── Hub (4端口)
│       └── 未知 USB 3.0 设备
├── Bus 03: xHCI 控制器 (480M)       ← USB 2.0
│   └── Hub (4端口)
├── Bus 02: OHCI 控制器 (12M)        ← USB 1.1
└── Bus 01: EHCI 控制器 (480M)       ← USB 2.0 高速
```

```shell
# lsusb -t
/:  Bus 06.Port 1: Dev 1, Class=root_hub, Driver=ohci-platform/1p, 12M
/:  Bus 05.Port 1: Dev 1, Class=root_hub, Driver=ehci-platform/1p, 480M
    |__ Port 1: Dev 2, If 0, Class=Wireless, Driver=rtk_btusb, 480M // 蓝牙控制，驱动 rtk_btusb
    |__ Port 1: Dev 2, If 1, Class=Wireless, Driver=rtk_btusb, 480M // 蓝牙音频，驱动 rtk_btusb
    |__ Port 1: Dev 2, If 2, Class=Vendor Specific Class, Driver=rtl8723du, 480M // WiFi 模块，驱动 rtl8723du
/:  Bus 04.Port 1: Dev 1, Class=root_hub, Driver=xhci-hcd/1p, 5000M
    |__ Port 1: Dev 2, If 0, Class=Hub, Driver=hub/4p, 5000M
        |__ Port 1: Dev 3, If 0, Class=, Driver=, 5000M // 未识别（Driver=空），可能是设备的主功能 - Fuzhou Rockchip Electronics Company
        |__ Port 1: Dev 3, If 1, Class=Vendor Specific Class, Driver=usbfs, 5000M // 供应商特定类，使用 usbfs 驱动（用户空间驱动）
/:  Bus 03.Port 1: Dev 1, Class=root_hub, Driver=xhci-hcd/1p, 480M
    |__ Port 1: Dev 2, If 0, Class=Hub, Driver=hub/4p, 480M
/:  Bus 02.Port 1: Dev 1, Class=root_hub, Driver=ohci-platform/1p, 12M
/:  Bus 01.Port 1: Dev 1, Class=root_hub, Driver=ehci-platform/1p, 480M
```

USB2.0 主机控制器（EHCI/OHCI）

* usb@fe380000 (EHCI)
* usb@fe3a0000 (OHCI)
* usb@fe3c0000 (EHCI)
* usb@fe3e0000 (OHCI)

这些都是传统的 USB 2.0 主机控制器，分别对应不同的物理端口。

2. USB3.0 控制器（DWC3）

usb0 (dwc3@fe800000):

* 位于 fe800000，支持 USB 3.0
* 工作模式为 OTG（可通过 Type-C 切换为 Host 或 Device）
* 关联的 PHY：usb2-phy 和 usb3-phy

usb1 (dwc3@fe900000):

* 位于 fe900000，支持 USB 3.0
* 工作模式为 Host
* 关联的 PHY：usb2-phy 和 usb3-phy

```shell
usb0 (DWC3, OTG)  <--> Type-C PHY 0 (USB3.0 模式)  <--> FUSB302 (CC/PD 控制)
usb1 (DWC3, Host) <--> Type-C PHY 1 (USB3.0 模式)
```

USB3.0 与 Type-C 的关联:

1. usb0 通过 Type-C PHY 0 连接到 Type-C 接口，并受 FUSB302 控制，支持：

* USB 3.0 数据传输
* DisplayPort Alt Mode（通过 DP 端口）
* 电源角色切换（Source/Sink）
* 数据角色切换（Host/Device）

2. usb1 通过 Type-C PHY 1 连接到另一个 Type-C 接口，仅作为 USB 3.0 Host。

```shell
/:  Bus 06.Port 1: Dev 1, Class=root_hub, Driver=ohci-platform/1p, 12M
/:  Bus 05.Port 1: Dev 1, Class=root_hub, Driver=ehci-platform/1p, 480M
    |__ Port 1: Dev 2, If 0, Class=Wireless, Driver=rtk_btusb, 480M
    |__ Port 1: Dev 2, If 1, Class=Wireless, Driver=rtk_btusb, 480M
    |__ Port 1: Dev 2, If 2, Class=Vendor Specific Class, Driver=rtl8723du, 480M
/:  Bus 04.Port 1: Dev 1, Class=root_hub, Driver=xhci-hcd/1p, 5000M
    |__ Port 1: Dev 2, If 0, Class=Hub, Driver=hub/4p, 5000M
        |__ Port 1: Dev 3, If 0, Class=, Driver=, 5000M
        |__ Port 1: Dev 3, If 1, Class=Vendor Specific Class, Driver=usbfs, 5000M
        |__ Port 2: Dev 4, If 0, Class=Mass Storage, Driver=usb-storage, 5000M
/:  Bus 03.Port 1: Dev 1, Class=root_hub, Driver=xhci-hcd/1p, 480M
    |__ Port 1: Dev 2, If 0, Class=Hub, Driver=hub/4p, 480M
        |__ Port 3: Dev 6, If 0, Class=Human Interface Device, Driver=usbhid, 1.5M
        |__ Port 4: Dev 7, If 0, Class=Human Interface Device, Driver=usbhid, 1.5M
        |__ Port 4: Dev 7, If 1, Class=Human Interface Device, Driver=usbhid, 1.5M
/:  Bus 02.Port 1: Dev 1, Class=root_hub, Driver=ohci-platform/1p, 12M
/:  Bus 01.Port 1: Dev 1, Class=root_hub, Driver=ehci-platform/1p, 480M
```

* 关于usb复位问题

```shell
	usbhub_reset: usbhub-reset {
		compatible = "usbhub-reset";
		uhrst-gpio = <&gpio4 21 GPIO_ACTIVE_HIGH>;
	};
```

RESET GPIO 是 GPIO4_21（ACTIVE_HIGH）

计算 GPIO 编号：GPIO4_21 → bank=4, pin=21 → 编号 = 4*32 + 21 = 149

```shell
echo 149 > /sys/class/gpio/export
echo out > /sys/class/gpio/gpio149/direction
echo 1 > /sys/class/gpio/gpio149/value   # 释放复位（因为 ACTIVE_HIGH）
sleep 1
dmesg | tail
lsusb
```

### dts配置

```shell
# ls /sys/bus/usb/devices/ -alh
total 0
drwxr-xr-x 2 root root 0 Jan 31 15:11 .
drwxr-xr-x 4 root root 0 Feb 20  2019 ..
lrwxrwxrwx 1 root root 0 Feb 20  2019 1-0:1.0 -> ../../../devices/platform/usb1/fe900000.dwc3/xhci-hcd.10.auto/usb1/1-0:1.0
lrwxrwxrwx 1 root root 0 Feb 20  2019 1-1 -> ../../../devices/platform/usb1/fe900000.dwc3/xhci-hcd.10.auto/usb1/1-1
lrwxrwxrwx 1 root root 0 Feb 20  2019 1-1:1.0 -> ../../../devices/platform/usb1/fe900000.dwc3/xhci-hcd.10.auto/usb1/1-1/1-1:1.0
lrwxrwxrwx 1 root root 0 Feb 20  2019 2-0:1.0 -> ../../../devices/platform/usb1/fe900000.dwc3/xhci-hcd.10.auto/usb2/2-0:1.0
lrwxrwxrwx 1 root root 0 Feb 20  2019 2-1 -> ../../../devices/platform/usb1/fe900000.dwc3/xhci-hcd.10.auto/usb2/2-1
lrwxrwxrwx 1 root root 0 Jan 31 07:34 2-1.1 -> ../../../devices/platform/usb1/fe900000.dwc3/xhci-hcd.10.auto/usb2/2-1/2-1.1
lrwxrwxrwx 1 root root 0 Jan 31 11:04 2-1.1:1.0 -> ../../../devices/platform/usb1/fe900000.dwc3/xhci-hcd.10.auto/usb2/2-1/2-1.1/2-1.1:1.0
lrwxrwxrwx 1 root root 0 Jan 31 11:04 2-1.1:1.1 -> ../../../devices/platform/usb1/fe900000.dwc3/xhci-hcd.10.auto/usb2/2-1/2-1.1/2-1.1:1.1
lrwxrwxrwx 1 root root 0 Feb 20  2019 2-1:1.0 -> ../../../devices/platform/usb1/fe900000.dwc3/xhci-hcd.10.auto/usb2/2-1/2-1:1.0
lrwxrwxrwx 1 root root 0 Feb 20  2019 3-0:1.0 -> ../../../devices/platform/fe380000.usb/usb3/3-0:1.0
lrwxrwxrwx 1 root root 0 Feb 20  2019 3-1 -> ../../../devices/platform/fe380000.usb/usb3/3-1
lrwxrwxrwx 1 root root 0 Feb 20  2019 3-1:1.0 -> ../../../devices/platform/fe380000.usb/usb3/3-1/3-1:1.0
lrwxrwxrwx 1 root root 0 Feb 20  2019 3-1:1.1 -> ../../../devices/platform/fe380000.usb/usb3/3-1/3-1:1.1
lrwxrwxrwx 1 root root 0 Feb 20  2019 3-1:1.2 -> ../../../devices/platform/fe380000.usb/usb3/3-1/3-1:1.2
lrwxrwxrwx 1 root root 0 Feb 20  2019 4-0:1.0 -> ../../../devices/platform/fe3c0000.usb/usb4/4-0:1.0
lrwxrwxrwx 1 root root 0 Feb 20  2019 5-0:1.0 -> ../../../devices/platform/fe3a0000.usb/usb5/5-0:1.0
lrwxrwxrwx 1 root root 0 Feb 20  2019 6-0:1.0 -> ../../../devices/platform/fe3e0000.usb/usb6/6-0:1.0
lrwxrwxrwx 1 root root 0 Feb 20  2019 usb1 -> ../../../devices/platform/usb1/fe900000.dwc3/xhci-hcd.10.auto/usb1
lrwxrwxrwx 1 root root 0 Feb 20  2019 usb2 -> ../../../devices/platform/usb1/fe900000.dwc3/xhci-hcd.10.auto/usb2
lrwxrwxrwx 1 root root 0 Feb 20  2019 usb3 -> ../../../devices/platform/fe380000.usb/usb3
lrwxrwxrwx 1 root root 0 Feb 20  2019 usb4 -> ../../../devices/platform/fe3c0000.usb/usb4
lrwxrwxrwx 1 root root 0 Feb 20  2019 usb5 -> ../../../devices/platform/fe3a0000.usb/usb5
lrwxrwxrwx 1 root root 0 Feb 20  2019 usb6 -> ../../../devices/platform/fe3e0000.usb/usb6
```

---

## 电源管理

### 硬件电路

主 PMIC：U2100 = DRK809-3（即 RK809） 另有两颗 TCS452x（TI 的 DCDC）： 一颗供 VDD_CPU_B（大核 A72）
一颗供 VDD_GPU

### dts配置

```shell
regulator.0 -> ../../devices/platform/reg-dummy/regulator/regulator.0
regulator.1 -> ../../devices/platform/vcc-phy-regulator/regulator/regulator.1
regulator.10 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.10
regulator.11 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.11
regulator.12 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.12
regulator.13 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.13
regulator.14 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.14
regulator.15 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.15
regulator.16 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.16
regulator.17 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.17
regulator.18 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.18
regulator.19 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.19
regulator.2 -> ../../devices/platform/vccsys/regulator/regulator.2
regulator.20 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.20
regulator.21 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.21
regulator.22 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-001c/regulator/regulator.22
regulator.23 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0010/regulator/regulator.23
regulator.3 -> ../../devices/platform/vdd_log/regulator/regulator.3
regulator.4 -> ../../devices/platform/vcc-4g-regulator/regulator/regulator.4
regulator.5 -> ../../devices/platform/vcc-pcie-regulator/regulator/regulator.5
regulator.6 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.6
regulator.7 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.7
regulator.8 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.8
regulator.9 -> ../../devices/platform/ff3c0000.i2c/i2c-0/0-0020/regulator/regulator.9
```

### 驱动配置

---

## i2c配置

### 硬件电路

### dts配置

```shell
root@armbian:~# ls -alh /sys/bus/i2c/devices/
total 0
drwxr-xr-x 2 root root 0 Jan  1  1970 .
drwxr-xr-x 4 root root 0 Jan  1  1970 ..
lrwxrwxrwx 1 root root 0 Jan  1  1970 0-0010 -> ../../../devices/platform/ff3c0000.i2c/i2c-0/0-0010
lrwxrwxrwx 1 root root 0 Jan  1  1970 0-001c -> ../../../devices/platform/ff3c0000.i2c/i2c-0/0-001c
lrwxrwxrwx 1 root root 0 Jan  1  1970 0-0020 -> ../../../devices/platform/ff3c0000.i2c/i2c-0/0-0020
lrwxrwxrwx 1 root root 0 Jan  1  1970 6-0047 -> ../../../devices/platform/ff150000.i2c/i2c-6/6-0047
lrwxrwxrwx 1 root root 0 Jan  1  1970 7-0013 -> ../../../devices/platform/ff160000.i2c/i2c-7/7-0013
lrwxrwxrwx 1 root root 0 Jan  1  1970 8-0022 -> ../../../devices/platform/ff3e0000.i2c/i2c-8/8-0022
lrwxrwxrwx 1 root root 0 Jan  1  1970 i2c-0 -> ../../../devices/platform/ff3c0000.i2c/i2c-0
lrwxrwxrwx 1 root root 0 Jan  1  1970 i2c-1 -> ../../../devices/platform/ff110000.i2c/i2c-1
lrwxrwxrwx 1 root root 0 Jan  1  1970 i2c-2 -> ../../../devices/platform/ff120000.i2c/i2c-2
lrwxrwxrwx 1 root root 0 Jan  1  1970 i2c-3 -> ../../../devices/platform/ff130000.i2c/i2c-3
lrwxrwxrwx 1 root root 0 Jan  1  1970 i2c-4 -> ../../../devices/platform/ff3d0000.i2c/i2c-4
lrwxrwxrwx 1 root root 0 Jan  1  1970 i2c-6 -> ../../../devices/platform/ff150000.i2c/i2c-6
lrwxrwxrwx 1 root root 0 Jan  1  1970 i2c-7 -> ../../../devices/platform/ff160000.i2c/i2c-7
lrwxrwxrwx 1 root root 0 Jan  1  1970 i2c-8 -> ../../../devices/platform/ff3e0000.i2c/i2c-8
```

### 驱动配置

---

## xxx配置

### 硬件电路

### dts配置

### 驱动配置

---

## MIPI屏幕配置

### 硬件电路

![](./images/4079247763000.png)

![](./images/4158826295500.png)


![](./images/46517075739700.png)

![](./images/46548752286200.png)



### dts配置

### 驱动配置

---

## hdmi配置

### 硬件电路

### dts配置

### 驱动配置

---

### 1. 镜像命名规则

镜像文件以 **armbian_${RELEASE}_${DESKTOP}.rar** 格式命名（默认架构为 aarch64）。

- **${RELEASE}**：发行版名称
- **${DESKTOP}**：桌面环境
  - `mini`：最小化构建（无图形界面）
  - `xfce`：带 XFce 图形界面
  - `gnome`：带 GNome 图形界面

### 2. 发行版与维护周期

| 发行版名称 | 操作系统           | 发布时间   | 结束维护时间         |
|------------|--------------------|------------|----------------------|
| bullseye   | Debian 11          | 2021-08-14 | 2026-06-30（LTS）    |
| bookworm   | Debian 12          | 2023-06-10 | 2028-06-10（LTS）    |
| trixie     | Debian 13          | 预计 2025  | 预计 2030            |
| forky      | Debian 14          | 预计 2027  | 预计 2032            |
| focal      | Ubuntu 20.04 LTS   | 2020-04-23 | 2025-04-30 |
| jammy      | Ubuntu 22.04 LTS   | 2022-04-21 | 2027-04-30 |
| noble      | Ubuntu 24.04 LTS   | 2024-04-25 | 2029-04-30 |
| oracular   | Ubuntu 24.10       | 2024-10-10 | 2025-07-31           |
| plucky     | Ubuntu 25.04       | 预计 2025-04 | 预计 2026-01        |
| resolute   | Ubuntu 25.10       | 预计 2025-10 | 预计 2026-07        |

> **说明**：
> - LTS 表示长期支持版本。
> - Ubuntu 非 LTS 版本通常提供 9 个月的支持周期。
> - Debian 每个版本通常提供约 5 年的支持（包括 LTS 阶段）。
> - 具体日期可能因官方调整而变化，请以发行方公告为准。

### 3. 系统默认账户

| 用户名 | 密码  |
|--------|-------|
| root   | admin |
| admin  | admin |